syntax = "proto3";

import "proto2ffi/options.proto";

// Database engine with transactions, cursors, and query execution

enum DataType {
    NULL = 0;
    INTEGER = 1;
    REAL = 2;
    TEXT = 3;
    BLOB = 4;
    BOOLEAN = 5;
}

enum TransactionState {
    IDLE = 0;
    ACTIVE = 1;
    COMMITTED = 2;
    ROLLED_BACK = 3;
}

enum IsolationLevel {
    READ_UNCOMMITTED = 0;
    READ_COMMITTED = 1;
    REPEATABLE_READ = 2;
    SERIALIZABLE = 3;
}

enum IndexType {
    BTREE = 0;
    HASH = 1;
    FULLTEXT = 2;
}

message Value {
    DataType type = 1;
    int64 int_value = 2;
    double real_value = 3;
    string text_value = 4 [(proto2ffi.max_length) = 1024];
    bytes blob_value = 5 [(proto2ffi.max_length) = 4096];
    bool bool_value = 6;
}

message Column {
    string name = 1 [(proto2ffi.max_length) = 64];
    DataType type = 2;
    bool nullable = 3;
    bool primary_key = 4;
    bool unique = 5;
}

message Row {
    option (proto2ffi.pool_size) = 10000;

    repeated Value values = 1 [(proto2ffi.max_count) = 32];
    uint32 column_count = 2;
}

message Table {
    string name = 1 [(proto2ffi.max_length) = 64];
    repeated Column columns = 2 [(proto2ffi.max_count) = 32];
    uint64 row_count = 3;
    uint64 page_count = 4;
}

message Query {
    option (proto2ffi.pool_size) = 1000;

    string sql = 1 [(proto2ffi.max_length) = 4096];
    repeated Value parameters = 2 [(proto2ffi.max_count) = 64];
    uint32 timeout_ms = 3;
}

message ResultSet {
    option (proto2ffi.pool_size) = 100;

    repeated Row rows = 1 [(proto2ffi.max_count) = 1000];
    uint32 row_count = 2;
    uint32 affected_rows = 3;
    uint64 last_insert_id = 4;
}

message Transaction {
    uint64 transaction_id = 1;
    TransactionState state = 2;
    IsolationLevel isolation = 3;
    uint64 start_time = 4;
    uint32 query_count = 5;
}

message Index {
    string name = 1 [(proto2ffi.max_length) = 64];
    string table_name = 2 [(proto2ffi.max_length) = 64];
    IndexType type = 3;
    repeated string columns = 4 [(proto2ffi.max_count) = 16];
    bool unique = 5;
}

message Cursor {
    uint64 cursor_id = 1;
    uint32 current_position = 2;
    uint32 total_rows = 3;
    bool is_open = 4;
    bool is_eof = 5;
}

message DatabaseStats {
    uint64 total_queries = 1;
    uint64 total_transactions = 2;
    uint64 cache_hits = 3;
    uint64 cache_misses = 4;
    uint64 page_reads = 5;
    uint64 page_writes = 6;
    double avg_query_time_ms = 7;
}

message ConnectionInfo {
    uint64 connection_id = 1;
    string database_name = 2 [(proto2ffi.max_length) = 256];
    uint64 connect_time = 3;
    uint32 active_queries = 4;
    uint32 active_transactions = 5;
}

message LockInfo {
    string table_name = 1 [(proto2ffi.max_length) = 64];
    uint64 transaction_id = 2;
    uint32 lock_type = 3;
    uint64 acquired_time = 4;
}

message QueryPlan {
    option (proto2ffi.pool_size) = 500;

    string operation = 1 [(proto2ffi.max_length) = 128];
    double estimated_cost = 2;
    uint64 estimated_rows = 3;
    repeated QueryPlan children = 4 [(proto2ffi.max_count) = 8];
}
