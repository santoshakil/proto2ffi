// Generated by proto2ffi FFI exports
// DO NOT EDIT

use super::*;
use crate::{HelloRequest, HelloResponse};
use prost::Message;

// Static service instance holder
// You must call init_greeter() before using the service
static mut GREETER_INSTANCE: Option<Box<dyn Greeter>> = None;

/// Initialize the Greeter service with your implementation
#[no_mangle]
pub unsafe extern "C" fn init_greeter(service: Box<dyn Greeter>) {
    GREETER_INSTANCE = Some(service);
}

/// FFI export for Greeter.SayHello
#[no_mangle]
pub unsafe extern "C" fn proto2ffi_say_hello(
    request_data: *const u8,
    request_len: usize,
) -> ByteBuffer {
    if request_data.is_null() || request_len == 0 {
        return ByteBuffer {
            ptr: std::ptr::null_mut(),
            len: 0,
            cap: 0,
        };
    }

    let service = match &GREETER_INSTANCE {
        Some(s) => s,
        None => {
            return ByteBuffer {
                ptr: std::ptr::null_mut(),
                len: 0,
                cap: 0,
            }
        }
    };

    let request_bytes = std::slice::from_raw_parts(request_data, request_len);

    let request = match HelloRequest::decode(request_bytes) {
        Ok(r) => r,
        Err(_) => {
            return ByteBuffer {
                ptr: std::ptr::null_mut(),
                len: 0,
                cap: 0,
            }
        }
    };

    let response = match service.say_hello(request) {
        Ok(r) => r,
        Err(_) => {
            return ByteBuffer {
                ptr: std::ptr::null_mut(),
                len: 0,
                cap: 0,
            }
        }
    };

    let mut response_bytes = Vec::new();
    if response.encode(&mut response_bytes).is_err() {
        return ByteBuffer {
            ptr: std::ptr::null_mut(),
            len: 0,
            cap: 0,
        };
    }

    ByteBuffer::from_vec(response_bytes)
}
